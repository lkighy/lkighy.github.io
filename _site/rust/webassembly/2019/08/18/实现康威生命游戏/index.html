
<!doctype html>














<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/assets/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/assets/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/assets/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="rust,WebAssembly,翻译," />





  <link rel="alternate" href="/atom.xml" title="青丘梦" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/assets/favicon.ico?v=5.1.1" />
















<meta name="description" content="在我们深入之前,我们有一些设计需要考虑.">
<meta name="keywords" content="rust, WebAssembly, 翻译">
<meta property="og:type" content="article">
<meta property="og:title" content="实现康威生命游戏">
<meta property="og:url" content="http://localhost:4000/rust/webassembly/2019/08/18/%E5%AE%9E%E7%8E%B0%E5%BA%B7%E5%A8%81%E7%94%9F%E5%91%BD%E6%B8%B8%E6%88%8F/">
<meta property="og:site_name" content="青丘梦">
<meta property="og:description" content="在我们深入之前,我们有一些设计需要考虑.">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://rustwasm.github.io/book/images/game-of-life/universe.png">
<meta property="og:image" content="https://rustwasm.github.io/book/images/game-of-life/initial-game-of-life-pre.png">
<meta property="og:image" content="https://rustwasm.github.io/book/images/game-of-life/initial-game-of-life.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="实现康威生命游戏">
<meta name="twitter:description" content="在我们深入之前,我们有一些设计需要考虑.">
<meta name="twitter:image" content="https://rustwasm.github.io/book/images/game-of-life/universe.png">


<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"hide","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://localhost:4000/"/>





  <title>实现康威生命游戏 | 青丘梦</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-146146679-1', 'auto');
  ga('send', 'pageview');
</script>













</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">青丘梦</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

<div id="posts" class="posts-expand">
  
  

  

  
  
  

  <article class="post post-type- " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://localhost:4000/rust/webassembly/2019/08/18/%E5%AE%9E%E7%8E%B0%E5%BA%B7%E5%A8%81%E7%94%9F%E5%91%BD%E6%B8%B8%E6%88%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="lkighy">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/assets/images/profile.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="青丘梦">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
          
          
            实现康威生命游戏
          
        </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-18T00:00:00-07:00">
                2019-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/category/#/rust%2FWebAssembly" itemprop="url" rel="index">
                    <span itemprop="name">rust/WebAssembly</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          
            
                <div class="post-description">
                    在我们深入之前,我们有一些设计需要考虑.
                </div>
            
          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
  
  












  <h2 id="设计">设计</h2>

<p>在我们深入之前,我们有一些设计需要考虑.</p>

<h3 id="无限的-universe">无限的 universe</h3>

<p>生命游戏是在无限的 universe 中进行的,但我们没有无限的内存和计算能力.解决这个相当烦人的限制通常由一下三种选择:</p>

<ol>
  <li>跟踪 universe 的哪个子集发生了有趣的事情,并根据需要扩展此区域.在最坏的情况下,这种扩展是无限制的,实现将变得越来越慢,,最终耗尽内存.</li>
  <li>创建固定大小的 universe ,其中边缘上的单元格比中间的单元格具有更少的邻居.这种方法缺点是达到 universe 尽头的无限的,如同滑翔机这样的到达了 universe 尽头,都会被消灭.</li>
  <li>创建一个固定大小固定周期的 universe ,其中边缘上的单元格连接着 universe 另一侧的单元格,因为连接临近的 universe ,滑翔机可以永远运行下去.</li>
</ol>

<p>我们将实现第三种选择.</p>

<h3 id="连接-rust-和-javascript">连接 Rust 和 JavaScript</h3>

<blockquote>
  <p>⚡即便离开了本教程,这也是最重要的概念之一!</p>
</blockquote>

<p>JavaScript 中的垃圾回收器(其中分配了 <code class="highlighter-rouge">object</code>, <code class="highlighter-rouge">array</code> 和 DOM 节点) 与 WebAssembly 的线性内存空间不同,后者存在于 Rust 值所在的空间.WebAssembly 目前无法直接访问垃圾回收器(截至 2018年 4月,预计会随着 <a href="https://github.com/WebAssembly/webidl-bindings/blob/master/proposals/webidl-bindings/Explainer.md">“webIDL bindings” 提案</a>而改变).另一方面,JavaScript 可以读取和写入 WebAssembly 线性内存空间,但只能作为 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer"><code class="highlighter-rouge">ArrayBuffer</code></a> 的标量值(<code class="highlighter-rouge">u8</code>, <code class="highlighter-rouge">i32</code>, f64` 等等…).WebAssembly 函数也接受并返回标量值.这些是构成所有 WebAssembly 和 JavaScript 通信的构建块.</p>

<p><code class="highlighter-rouge">wasm_bindgen</code> 定义了如何跨越此边界适用符合构建的共同协议.它涉及装箱 Rust 结构,将指针包装在 JavaScript 类中或从 Rust 索引到 JavaScript 对象表中以便使用.<code class="highlighter-rouge">wasm_bindgen</code> 非常方便,但它不需要我们考虑数据表示,以及跨越此边界传递的值和结构.相反,您可以将其视为实现所有界面设计的工具.</p>

<p>在设计 webAssembly 和 JavaScript 之间的接口时,我们希望针对一下属性进行优化:</p>

<ol>
  <li><strong>复制进入 WebAssembly 线性内存的将是最小化的.</strong>不必要的副本会带来不必要的开销.</li>
  <li><strong>最小序列化和反序列化.</strong>与副本类似,序列化和反序列化也会产生开销,并且通常会造成复制.如果我们可以将不透明句柄传递给数据结构 - 而不是在一侧将其序列化,再复制到 WebAssembly 线性内存中的某个已知位置,并再另一侧进行反序列化 - 我们通常可以减少大量开销.<code class="highlighter-rouge">wasm_bindgen</code> 帮助我们定义可处理 JavaScript 对象或将 Rust 结构装入不透明句柄.</li>
</ol>

<p>通常的经验时,良好的 JavaScript ↔ WebAssembly 接口设计通常时间大型的,长期存在的数据结构实现为驻留在 WebAssembly 的 Rust 类型,并将其作为不透明句柄暴露给 JavaScript .JavaScript 调用导出的 WebAssembly 函数,这些函数接受这些不透明句柄,转换数据,执行繁重的计算,查询数据,最终返回一个小的可复制的结果.通过返回计算的小小的结果,我们避免在 JavaScript 垃圾回收器 和 WebAssembly 线性内存之间来回复制/序列化所有内容.</p>

<h3 id="在我们的生命游戏中连接-rust-和-javascript">在我们的生命游戏中连接 Rust 和 JavaScript</h3>

<p>首先我们列举一些要避免的危险,我们不希望再每个 tick 上将整个 universe 复制到 WebAssembly 线性内存中.我们不希望为 universe 中每个单元分配对象,也不想强制进行跨边界调用来读写每个单元.</p>

<p>这会给我们留下什么?我们可以将 universe 表示为一个平面数组,它存在于 WebAssembly 线性内存中,每个单元都有一个字节.  0 是死细胞,1 是活细胞.</p>

<p>这是 4 × 4  universe 再内存中的样子:</p>

<p><img src="https://rustwasm.github.io/book/images/game-of-life/universe.png" alt="universe" /></p>

<p>要在  universe 中的给定行和列中查找单元格的数组索引,我们可以使用一下公式:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1</pre></td><td class="code"><pre class="highlight"><code>index(row, column, universe) = row * width(universe) + column
</code></pre></td></tr></tbody></table></div></div>

<p>我们有几种方法可以将 universe 的单元格暴露给 JavaScript.首先,我们将 <code class="highlighter-rouge">Universe</code> 实现 <code class="highlighter-rouge">std::fmt::Display</code>,我们可以使用它来生成呈现为文本字符的单元格 Rust String.然后将此 Rust String 从 WebAssembly 先行内存复制到 JavaScript 的垃圾回收器中的 JavaScript String 中,然后通过 设置 HTML textContent 显示.再本章的后面我们将改进这个实现,以避免再队之间复制 universe 的单元格渲染到 <code class="highlighter-rouge">&lt;canvas&gt;</code>(画布).</p>

<p><em>另一个可行的设计代替方案是 Rust 返回每一个更改状态后的细胞的单元格刘表,而不是整个 universe 暴露给 JavScript.这样,JavaScript 在渲染时不需要遍历整个 universe, 只需要相关的子集.折中之处在于,这种基于 delta-based 设计更难实现.</em></p>

<h2 id="rust实现">Rust实现</h2>

<p>在上一章中,我们克隆了一个初始项目模板.我们现在将修改该项目模板.</p>

<p>让我们首先从 <code class="highlighter-rouge">wasm-game-of-life/ssrc/lib.rs</code> 中删除 <code class="highlighter-rouge">alert</code> 模块和 <code class="highlighter-rouge">greet</code> 函数,然后定义单元格的类型替换它们:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3<br/>4<br/>5<br/>6<br/>7</pre></td><td class="code"><pre class="highlight"><code><span class="err">#</span><span class="p">[</span><span class="n">wasm_bindgen</span><span class="p">]</span>
<span class="nd">#[repr(u8)]</span>
<span class="nd">#[derive(Clone,</span> <span class="nd">Copy,</span> <span class="nd">Debug,</span> <span class="nd">PartialEq,</span> <span class="nd">Eq)]</span>
<span class="k">pub</span> <span class="k">enum</span> <span class="n">Cell</span> <span class="p">{</span>
    <span class="n">Dead</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">Alive</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></td></tr></tbody></table></div></div>

<p>重要的是 <code class="highlighter-rouge">#[repr(u8)]</code>,和 <code class="highlighter-rouge">Dead</code>, <code class="highlighter-rouge">Alive</code>.<code class="highlighter-rouge">#[repr(u8)]</code> 将每个单元表示为一个字节; <code class="highlighter-rouge">Dead</code> 表示死细胞,变量为 <code class="highlighter-rouge">0</code>; <code class="highlighter-rouge">Alive</code> 表示活细胞,变量为 ‘1’, 这样我们就可以通过相加轻易计算出单元格活着的邻居.</p>

<p>接下来让我们定义 universe,universe 具有宽度和高度,以及 <code class="highlighter-rouge">width * height</code> 长度的 vector.</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3<br/>4<br/>5<br/>6</pre></td><td class="code"><pre class="highlight"><code><span class="err">#</span><span class="p">[</span><span class="n">wasm_bindgen</span><span class="p">]</span>
<span class="k">pub</span> <span class="k">struct</span> <span class="n">Universe</span> <span class="p">{</span>
    <span class="n">width</span><span class="p">:</span> <span class="nb">u32</span><span class="p">,</span>
    <span class="n">height</span><span class="p">:</span> <span class="nb">u32</span><span class="p">,</span>
    <span class="n">cells</span><span class="p">:</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Cell</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></td></tr></tbody></table></div></div>

<p>要访问给定行和列的 cells,我们将行和列转换为 cells vector 索引,如前所述:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3<br/>4<br/>5<br/>6<br/>7</pre></td><td class="code"><pre class="highlight"><code><span class="k">impl</span> <span class="n">Universe</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">get_index</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">row</span><span class="p">:</span> <span class="nb">u32</span><span class="p">,</span> <span class="n">column</span><span class="p">:</span> <span class="nb">u32</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">usize</span> <span class="p">{</span>
        <span class="p">(</span><span class="n">row</span> <span class="o">*</span> <span class="k">self</span><span class="py">.width</span> <span class="o">+</span> <span class="n">column</span><span class="p">)</span> <span class="k">as</span> <span class="nb">usize</span>
    <span class="p">}</span>

    <span class="c">// ...</span>
<span class="p">}</span>
</code></pre></td></tr></tbody></table></div></div>

<p>为了计算细胞的下一状态,我们需要计算邻居数量是多少.让我们编写一个 <code class="highlighter-rouge">live_neighbor_count</code> 方法来做到这一点!</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3<br/>4<br/>5<br/>6<br/>7<br/>8<br/>9<br/>10<br/>11<br/>12<br/>13<br/>14<br/>15<br/>16<br/>17<br/>18<br/>19<br/>20</pre></td><td class="code"><pre class="highlight"><code><span class="k">impl</span> <span class="n">Universe</span> <span class="p">{</span>
    <span class="c">// ...</span>

    <span class="k">fn</span> <span class="nf">live_neighbor_count</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">row</span><span class="p">:</span> <span class="nb">u32</span><span class="p">,</span> <span class="n">column</span><span class="p">:</span> <span class="nb">u32</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">u8</span> <span class="p">{</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="n">delta_row</span> <span class="n">in</span> <span class="p">[</span><span class="k">self</span><span class="py">.height</span> <span class="err">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="nf">.iter</span><span class="p">()</span><span class="nf">.cloned</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">for</span> <span class="n">delta_col</span> <span class="n">in</span> <span class="p">[</span><span class="k">self</span><span class="py">.width</span> <span class="err">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="nf">.iter</span><span class="p">()</span><span class="nf">.cloned</span><span class="p">()</span> <span class="p">{</span>
                <span class="k">if</span> <span class="n">delta_row</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">delta_col</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
                    <span class="n">continue</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">let</span> <span class="n">neighbor_row</span> <span class="o">=</span> <span class="p">(</span><span class="n">row</span> <span class="o">+</span> <span class="n">delta_row</span><span class="p">)</span> <span class="o">%</span> <span class="k">self</span><span class="py">.height</span><span class="p">;</span>
                <span class="k">let</span> <span class="n">neighbor_col</span> <span class="o">=</span> <span class="p">(</span><span class="n">column</span> <span class="o">+</span> <span class="n">delta_col</span><span class="p">)</span> <span class="o">%</span> <span class="k">self</span><span class="py">.width</span><span class="p">;</span>
                <span class="k">let</span> <span class="n">idx</span> <span class="o">=</span> <span class="k">self</span><span class="nf">.get_index</span><span class="p">(</span><span class="n">neighbor_row</span><span class="p">,</span> <span class="n">neighbor_col</span><span class="p">);</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="k">self</span><span class="py">.cells</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">as</span> <span class="nb">u8</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">count</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></tbody></table></div></div>

<p><code class="highlighter-rouge">live_neighobor_count</code> 方法使用 deltas 取余的方法对 universe 边缘进行特殊包装来避免使用 <code class="highlighter-rouge">if</code>. 当 delta <code class="highlighter-rouge">-1</code> 时,我们添加 <code class="highlighter-rouge">self.height - 1</code> 并使用取余来完成这件事,而不是使用 <code class="highlighter-rouge">-1</code> . <code class="highlighter-rouge">row</code> 和 <code class="highlighter-rouge">column</code> 可以为零,如果我们试图让为 <code class="highlighter-rouge">0</code> 的它们减去 <code class="highlighter-rouge">1</code> ,则会出现无符号整数下溢.</p>

<p>现在我们拥有了从当前一代计算下一代所需要的一切!现在将游戏的每一个规则转换为 <code class="highlighter-rouge">match</code> 表达式上的条件.另外,我们希望 javaScript 通过 tick 控制发生的时间,因此我们会将此方法放在 <code class="highlighter-rouge">#[wasm_bindgen]</code> 块中,这样它就会暴露给 JavaScript.</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3<br/>4<br/>5<br/>6<br/>7<br/>8<br/>9<br/>10<br/>11<br/>12<br/>13<br/>14<br/>15<br/>16<br/>17<br/>18<br/>19<br/>20<br/>21<br/>22<br/>23<br/>24<br/>25<br/>26<br/>27<br/>28<br/>29<br/>30<br/>31<br/>32<br/>33<br/>34<br/>35<br/>36<br/>37<br/>38</pre></td><td class="code"><pre class="highlight"><code><span class="c">/// Public methods, exported to JavaScript.</span>
<span class="nd">#[wasm_bindgen]</span>
<span class="k">impl</span> <span class="n">Universe</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">tick</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">next</span> <span class="o">=</span> <span class="k">self</span><span class="py">.cells</span><span class="nf">.clone</span><span class="p">();</span>

        <span class="k">for</span> <span class="n">row</span> <span class="n">in</span> <span class="mi">0</span><span class="o">..</span><span class="k">self</span><span class="py">.height</span> <span class="p">{</span>
            <span class="k">for</span> <span class="n">col</span> <span class="n">in</span> <span class="mi">0</span><span class="o">..</span><span class="k">self</span><span class="py">.width</span> <span class="p">{</span>
                <span class="k">let</span> <span class="n">idx</span> <span class="o">=</span> <span class="k">self</span><span class="nf">.get_index</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">);</span>
                <span class="k">let</span> <span class="n">cell</span> <span class="o">=</span> <span class="k">self</span><span class="py">.cells</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
                <span class="k">let</span> <span class="n">live_neighbors</span> <span class="o">=</span> <span class="k">self</span><span class="nf">.live_neighbor_count</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">);</span>

                <span class="k">let</span> <span class="n">next_cell</span> <span class="o">=</span> <span class="k">match</span> <span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">live_neighbors</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c">// Rule 1: Any live cell with fewer than two live neighbours</span>
                    <span class="c">// dies, as if caused by underpopulation.</span>
                    <span class="p">(</span><span class="nn">Cell</span><span class="p">::</span><span class="n">Alive</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="k">=&gt;</span> <span class="nn">Cell</span><span class="p">::</span><span class="n">Dead</span><span class="p">,</span>
                    <span class="c">// Rule 2: Any live cell with two or three live neighbours</span>
                    <span class="c">// lives on to the next generation.</span>
                    <span class="p">(</span><span class="nn">Cell</span><span class="p">::</span><span class="n">Alive</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="p">|</span> <span class="p">(</span><span class="nn">Cell</span><span class="p">::</span><span class="n">Alive</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="nn">Cell</span><span class="p">::</span><span class="n">Alive</span><span class="p">,</span>
                    <span class="c">// Rule 3: Any live cell with more than three live</span>
                    <span class="c">// neighbours dies, as if by overpopulation.</span>
                    <span class="p">(</span><span class="nn">Cell</span><span class="p">::</span><span class="n">Alive</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="k">=&gt;</span> <span class="nn">Cell</span><span class="p">::</span><span class="n">Dead</span><span class="p">,</span>
                    <span class="c">// Rule 4: Any dead cell with exactly three live neighbours</span>
                    <span class="c">// becomes a live cell, as if by reproduction.</span>
                    <span class="p">(</span><span class="nn">Cell</span><span class="p">::</span><span class="n">Dead</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="nn">Cell</span><span class="p">::</span><span class="n">Alive</span><span class="p">,</span>
                    <span class="c">// All other cells remain in the same state.</span>
                    <span class="p">(</span><span class="n">otherwise</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="n">otherwise</span><span class="p">,</span>
                <span class="p">};</span>

                <span class="n">next</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_cell</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">self</span><span class="py">.cells</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c">// ...</span>
<span class="p">}</span>
</code></pre></td></tr></tbody></table></div></div>

<p>到目前为止, Universe 的状态被表现为 cells vector.为了让其更易读,让我们实现一个基本的文本渲染器(text renderer).我们的想法时将 Universe 逐行写为文本,对于每个活细胞,我们将打印 Unicode 字符 <code class="highlighter-rouge">◼</code>(“黑色中等方块”).对于死细胞,我们将打印<code class="highlighter-rouge">◻</code>(“白色中等方块”).</p>

<p>通过实现 Rust 标准库中 <code class="highlighter-rouge">Display</code> 的 trait, 我们可以添加一种以面向用户的方式的格式化结构的方法.这也会自动给我们一个 <code class="highlighter-rouge">to_string</code> 方法.</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3<br/>4<br/>5<br/>6<br/>7<br/>8<br/>9<br/>10<br/>11<br/>12<br/>13<br/>14<br/>15</pre></td><td class="code"><pre class="highlight"><code><span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="n">fmt</span><span class="p">;</span>

<span class="k">impl</span> <span class="nn">fmt</span><span class="p">::</span><span class="n">Display</span> <span class="k">for</span> <span class="n">Universe</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">fmt</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">f</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="nn">fmt</span><span class="p">::</span><span class="n">Formatter</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nn">fmt</span><span class="p">::</span><span class="n">Result</span> <span class="p">{</span>
        <span class="k">for</span> <span class="n">line</span> <span class="n">in</span> <span class="k">self</span><span class="py">.cells</span><span class="nf">.as_slice</span><span class="p">()</span><span class="nf">.chunks</span><span class="p">(</span><span class="k">self</span><span class="py">.width</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="o">&amp;</span><span class="n">cell</span> <span class="n">in</span> <span class="n">line</span> <span class="p">{</span>
                <span class="k">let</span> <span class="n">symbol</span> <span class="o">=</span> <span class="k">if</span> <span class="n">cell</span> <span class="o">==</span> <span class="nn">Cell</span><span class="p">::</span><span class="n">Dead</span> <span class="p">{</span> <span class="sc">'◻'</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="sc">'◼'</span> <span class="p">};</span>
                <span class="nd">write!</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">"{}"</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nd">write!</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nf">Ok</span><span class="p">(())</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></tbody></table></div></div>

<p>最后,我们定义一个构造函数,用一个有趣的活细胞死细胞模式初始化宇宙,以及一个 <code class="highlighter-rouge">render</code> 方法:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3<br/>4<br/>5<br/>6<br/>7<br/>8<br/>9<br/>10<br/>11<br/>12<br/>13<br/>14<br/>15<br/>16<br/>17<br/>18<br/>19<br/>20<br/>21<br/>22<br/>23<br/>24<br/>25<br/>26<br/>27<br/>28<br/>29<br/>30</pre></td><td class="code"><pre class="highlight"><code><span class="c">/// Public methods, exported to JavaScript.</span>
<span class="nd">#[wasm_bindgen]</span>
<span class="k">impl</span> <span class="n">Universe</span> <span class="p">{</span>
    <span class="c">// ...</span>

    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">new</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="n">Universe</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">width</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
        <span class="k">let</span> <span class="n">height</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>

        <span class="k">let</span> <span class="n">cells</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="n">width</span> <span class="o">*</span> <span class="n">height</span><span class="p">)</span>
            <span class="nf">.map</span><span class="p">(|</span><span class="n">i</span><span class="p">|</span> <span class="p">{</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">||</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">7</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
                    <span class="nn">Cell</span><span class="p">::</span><span class="n">Alive</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nn">Cell</span><span class="p">::</span><span class="n">Dead</span>
                <span class="p">}</span>
            <span class="p">})</span>
            <span class="nf">.collect</span><span class="p">();</span>

        <span class="n">Universe</span> <span class="p">{</span>
            <span class="n">width</span><span class="p">,</span>
            <span class="n">height</span><span class="p">,</span>
            <span class="n">cells</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">render</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">String</span> <span class="p">{</span>
        <span class="k">self</span><span class="nf">.to_string</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></tbody></table></div></div>

<p>有了这个,我们 Rust 实现的生命游戏就完成一半了!</p>

<p>通过 <code class="highlighter-rouge">wasm-pack</code> 在 <code class="highlighter-rouge">wasm-game-of-life</code> 目录中运行将其重新编译为 WebAssembly.</p>

<h2 id="使用-javascript-渲染">使用 JavaScript 渲染</h2>

<p>首先,让我们在 <code class="highlighter-rouge">wasm-game-of-life/www/index.html</code> 中添加一个 <code class="highlighter-rouge">&lt;pre&gt;</code> 元素来渲染 universe,就添加在 <code class="highlighter-rouge">&lt;script&gt;</code> 标签上方:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3<br/>4</pre></td><td class="code"><pre class="highlight"><code><span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;pre</span> <span class="na">id=</span><span class="s">"game-of-life-canvas"</span><span class="nt">&gt;&lt;/pre&gt;</span>
  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"./bootstrap.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>
</code></pre></td></tr></tbody></table></div></div>

<p>此外,我们希望 <code class="highlighter-rouge">&lt;pre&gt;</code> 居中在网页的中间.我们可以使用 CSS 弹性盒子来完成这项任务. 在 <code class="highlighter-rouge">wasm-game-of-life/www/index.html</code> 中 <code class="highlighter-rouge">head</code>标签添加以下代码:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3<br/>4<br/>5<br/>6<br/>7<br/>8<br/>9<br/>10<br/>11<br/>12<br/>13</pre></td><td class="code"><pre class="highlight"><code><span class="nt">&lt;style&gt;</span>
  <span class="nt">body</span> <span class="p">{</span>
    <span class="nl">position</span><span class="p">:</span> <span class="nb">absolute</span><span class="p">;</span>
    <span class="nl">top</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span>
    <span class="nl">left</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span>
    <span class="nl">width</span><span class="p">:</span> <span class="m">100%</span><span class="p">;</span>
    <span class="nl">height</span><span class="p">:</span> <span class="m">100%</span><span class="p">;</span>
    <span class="nl">display</span><span class="p">:</span> <span class="n">flex</span><span class="p">;</span>
    <span class="nl">flex-direction</span><span class="p">:</span> <span class="n">column</span><span class="p">;</span>
    <span class="nl">align-items</span><span class="p">:</span> <span class="nb">center</span><span class="p">;</span>
    <span class="nl">justify-content</span><span class="p">:</span> <span class="nb">center</span><span class="p">;</span>
  <span class="p">}</span>
<span class="nt">&lt;/style&gt;</span>
</code></pre></td></tr></tbody></table></div></div>

<p>在 <code class="highlighter-rouge">wasm-game-of-life/www/index.js</code> 的顶部,让我们将导入的 <code class="highlighter-rouge">greet</code> 方法替换为 <code class="highlighter-rouge">Universe</code>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1</pre></td><td class="code"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Universe</span> <span class="p">}</span> <span class="k">from</span> <span class="s2">"wasm-game-of-life"</span><span class="p">;</span>
</code></pre></td></tr></tbody></table></div></div>

<p>另外,让我们为刚刚添加的 <code class="highlighter-rouge">&lt;pre&gt;</code> 元素实例化一个新的 Universe:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2</pre></td><td class="code"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">pre</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"game-of-life-canvas"</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">universe</span> <span class="o">=</span> <span class="nx">Universe</span><span class="p">.</span><span class="k">new</span><span class="p">();</span>
</code></pre></td></tr></tbody></table></div></div>

<p>JavaScript 运行在一个 <a href="https://developer.mozilla.org/en-US/docs/Web/API/window/requestAnimationFrame"><code class="highlighter-rouge">requestAnimationFrame</code> 循环中</a>.在每次迭代中,他将当前 Universe 绘制到 <code class="highlighter-rouge">&lt;pre&gt;</code> ,然后调用 <code class="highlighter-rouge">Universe::tick</code>.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3<br/>4<br/>5<br/>6</pre></td><td class="code"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">renderLoop</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">pre</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">universe</span><span class="p">.</span><span class="nx">render</span><span class="p">()</span>
    <span class="nx">universe</span><span class="p">.</span><span class="nx">tick</span><span class="p">();</span>

    <span class="nx">requestAnimationFrame</span><span class="p">(</span><span class="nx">renderLoop</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></tbody></table></div></div>

<p>要开始渲染过程前,我们还要为渲染循环的第一次迭代进行初始化调用:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1</pre></td><td class="code"><pre class="highlight"><code><span class="nx">requestAnimationFrame</span><span class="p">(</span><span class="nx">renderLoop</span><span class="p">);</span>
</code></pre></td></tr></tbody></table></div></div>

<p>确保您的开发服务器正在运行(在 <code class="highlighter-rouge">wasm-game-of-life/www</code> 目录下运行 <code class="highlighter-rouge">npm run start</code>),访问 <a href="http://localhost:8080/">http://localhost:8080/</a> 页面应该是这样的:</p>

<p><img src="https://rustwasm.github.io/book/images/game-of-life/initial-game-of-life-pre.png" alt="带有文本渲染的Game of Life实现的屏幕截图" /></p>

<h2 id="直接从内存渲染到画布">直接从内存渲染到画布</h2>

<p>在 Rust 中生成(并分配)一个 <code class="highlighter-rouge">String</code>,然后让 <code class="highlighter-rouge">wasm-bindgen</code> 将它转换为一个有效的 JavaScript 字符串,就会产生不必要的 universe cells 副本.由于 JavaScript 代码已经知道了 universe 的宽度和高度,因此我们将修改 <code class="highlighter-rouge">render</code> 方法以返回 cells 数组开头的指针.</p>

<p>此外,我们将使用 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API">Canvas API</a>来代替 Unicode 文本,而不是渲染为 Unicode 文本,我们将在本教程剩余的部分使用此设计.</p>

<p>在 <code class="highlighter-rouge">wasm-game-of-life/www/index.html</code> 里,让我们用 <code class="highlighter-rouge">&lt;canvas&gt;</code> 取代之前添加 <code class="highlighter-rouge">&lt;pre&gt;</code> 来呈现内容(它也应该在我们加载 JavaScript 的脚本前.)</p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3<br/>4</pre></td><td class="code"><pre class="highlight"><code><span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;canvas</span> <span class="na">id=</span><span class="s">"game-of-life-canvas"</span><span class="nt">&gt;&lt;/canvas&gt;</span>
  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">'./bootstrap.js'</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>
</code></pre></td></tr></tbody></table></div></div>

<p>为了从 Rust 实现中获得必要的信息,我们需要为 universe 的 width, height 和 指向 cell 数组的指针添加更多的 getter 函数.这些都将暴露给 JavaScript.将这些添加到 <code class="highlighter-rouge">wasm-game-of-life/src/lib.rs</code>:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3<br/>4<br/>5<br/>6<br/>7<br/>8<br/>9<br/>10<br/>11<br/>12<br/>13<br/>14<br/>15<br/>16<br/>17</pre></td><td class="code"><pre class="highlight"><code><span class="c">/// Public methods, exported to JavaScript.</span>
<span class="nd">#[wasm_bindgen]</span>
<span class="k">impl</span> <span class="n">Universe</span> <span class="p">{</span>
    <span class="c">// ...</span>

    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">width</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">u32</span> <span class="p">{</span>
        <span class="k">self</span><span class="py">.width</span>
    <span class="p">}</span>

    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">height</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">u32</span> <span class="p">{</span>
        <span class="k">self</span><span class="py">.height</span>
    <span class="p">}</span>

    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">cells</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">*</span><span class="k">const</span> <span class="n">Cell</span> <span class="p">{</span>
        <span class="k">self</span><span class="py">.cells</span><span class="nf">.as_ptr</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></tbody></table></div></div>

<p>接下来,在 <code class="highlighter-rouge">wasm-game-of-life/www/index.js</code> 中,让我们从 <code class="highlighter-rouge">wasm-game-of-life</code> 导入 <code class="highlighter-rouge">Cell</code>,并定义一些常量,我们将在 渲染到画布时使用这些常量:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3<br/>4<br/>5<br/>6</pre></td><td class="code"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Universe</span><span class="p">,</span> <span class="nx">Cell</span> <span class="p">}</span> <span class="k">from</span> <span class="s2">"wasm-game-of-life"</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">CELL_SIZE</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="c1">// px</span>
<span class="kd">const</span> <span class="nx">GRID_COLOR</span> <span class="o">=</span> <span class="s2">"#CCCCCC"</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">DEAD_COLOR</span> <span class="o">=</span> <span class="s2">"#FFFFFF"</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">ALIVE_COLOR</span> <span class="o">=</span> <span class="s2">"#000000"</span><span class="p">;</span>
</code></pre></td></tr></tbody></table></div></div>

<p>现在,让我们重写其余的 JavaScript 代码.不再写入给 <code class="highlighter-rouge">&lt;pre&gt;</code> 写入 <code class="highlighter-rouge">textContent</code> 而是绘制到 <code class="highlighter-rouge">&lt;canvas&gt;</code>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3<br/>4<br/>5<br/>6<br/>7<br/>8<br/>9<br/>10<br/>11<br/>12<br/>13<br/>14<br/>15<br/>16<br/>17<br/>18<br/>19<br/>20<br/>21</pre></td><td class="code"><pre class="highlight"><code><span class="c1">// Construct the universe, and get its width and height.</span>
<span class="kd">const</span> <span class="nx">universe</span> <span class="o">=</span> <span class="nx">Universe</span><span class="p">.</span><span class="k">new</span><span class="p">();</span>
<span class="kd">const</span> <span class="nx">width</span> <span class="o">=</span> <span class="nx">universe</span><span class="p">.</span><span class="nx">width</span><span class="p">();</span>
<span class="kd">const</span> <span class="nx">height</span> <span class="o">=</span> <span class="nx">universe</span><span class="p">.</span><span class="nx">height</span><span class="p">();</span>

<span class="c1">// Give the canvas room for all of our cells and a 1px border</span>
<span class="c1">// around each of them.</span>
<span class="kd">const</span> <span class="nx">canvas</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"game-of-life-canvas"</span><span class="p">);</span>
<span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="p">(</span><span class="nx">CELL_SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">height</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="p">(</span><span class="nx">CELL_SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">width</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">'2d'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">renderLoop</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">universe</span><span class="p">.</span><span class="nx">tick</span><span class="p">();</span>

  <span class="nx">drawGrid</span><span class="p">();</span>
  <span class="nx">drawCells</span><span class="p">();</span>

  <span class="nx">requestAnimationFrame</span><span class="p">(</span><span class="nx">renderLoop</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></td></tr></tbody></table></div></div>

<p>为了在 cells 之间绘制网格,我们绘制一组等间距的水平线,和一组等间距的垂直线.这些横纵线交错形成网格.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3<br/>4<br/>5<br/>6<br/>7<br/>8<br/>9<br/>10<br/>11<br/>12<br/>13<br/>14<br/>15<br/>16<br/>17<br/>18</pre></td><td class="code"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">drawGrid</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">ctx</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">();</span>
  <span class="nx">ctx</span><span class="p">.</span><span class="nx">strokeStyle</span> <span class="o">=</span> <span class="nx">GRID_COLOR</span><span class="p">;</span>

  <span class="c1">// Vertical lines.</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="nx">width</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">moveTo</span><span class="p">(</span><span class="nx">i</span> <span class="o">*</span> <span class="p">(</span><span class="nx">CELL_SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="nx">i</span> <span class="o">*</span> <span class="p">(</span><span class="nx">CELL_SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nx">CELL_SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">height</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Horizontal lines.</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;=</span> <span class="nx">height</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">moveTo</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>                           <span class="nx">j</span> <span class="o">*</span> <span class="p">(</span><span class="nx">CELL_SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">((</span><span class="nx">CELL_SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">width</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">j</span> <span class="o">*</span> <span class="p">(</span><span class="nx">CELL_SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">ctx</span><span class="p">.</span><span class="nx">stroke</span><span class="p">();</span>
<span class="p">};</span>
</code></pre></td></tr></tbody></table></div></div>

<p>我们可以通过 <code class="highlighter-rouge">memory</code> 直接访问 WebAssembly 的线性内存, <code class="highlighter-rouge">memory</code> 是直接在原始模块 <code class="highlighter-rouge">wasm_game_of_life_bg</code> 中定义的.为了绘制 cells,我们得到一个指向 universe cells 的指针,构建一个 <code class="highlighter-rouge">Uint8Array</code> 覆盖 cells 缓冲区,在每个细胞上迭代,并根据细胞是死的还是活的分别绘制一个白色或黑色矩形.通过使用指针和 <code class="highlighter-rouge">Uint8Array</code> ,我们避免在每个 tick 上跨边界复制 cells.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3<br/>4<br/>5<br/>6<br/>7<br/>8<br/>9<br/>10<br/>11<br/>12<br/>13<br/>14<br/>15<br/>16<br/>17<br/>18<br/>19<br/>20<br/>21<br/>22<br/>23<br/>24<br/>25<br/>26<br/>27<br/>28<br/>29<br/>30<br/>31<br/>32<br/>33<br/>34</pre></td><td class="code"><pre class="highlight"><code><span class="c1">// Import the WebAssembly memory at the top of the file.</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">memory</span> <span class="p">}</span> <span class="k">from</span> <span class="s2">"wasm-game-of-life/wasm_game_of_life_bg"</span><span class="p">;</span>

<span class="c1">// ...</span>

<span class="kd">const</span> <span class="nx">getIndex</span> <span class="o">=</span> <span class="p">(</span><span class="nx">row</span><span class="p">,</span> <span class="nx">column</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">row</span> <span class="o">*</span> <span class="nx">width</span> <span class="o">+</span> <span class="nx">column</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">const</span> <span class="nx">drawCells</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">cellsPtr</span> <span class="o">=</span> <span class="nx">universe</span><span class="p">.</span><span class="nx">cells</span><span class="p">();</span>
  <span class="kd">const</span> <span class="nx">cells</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Uint8Array</span><span class="p">(</span><span class="nx">memory</span><span class="p">.</span><span class="nx">buffer</span><span class="p">,</span> <span class="nx">cellsPtr</span><span class="p">,</span> <span class="nx">width</span> <span class="o">*</span> <span class="nx">height</span><span class="p">);</span>

  <span class="nx">ctx</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">();</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">row</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">row</span> <span class="o">&lt;</span> <span class="nx">height</span><span class="p">;</span> <span class="nx">row</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">col</span> <span class="o">&lt;</span> <span class="nx">width</span><span class="p">;</span> <span class="nx">col</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">idx</span> <span class="o">=</span> <span class="nx">getIndex</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span> <span class="nx">col</span><span class="p">);</span>

      <span class="nx">ctx</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="nx">cells</span><span class="p">[</span><span class="nx">idx</span><span class="p">]</span> <span class="o">===</span> <span class="nx">Cell</span><span class="p">.</span><span class="nx">Dead</span>
        <span class="p">?</span> <span class="nx">DEAD_COLOR</span>
        <span class="p">:</span> <span class="nx">ALIVE_COLOR</span><span class="p">;</span>

      <span class="nx">ctx</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span>
        <span class="nx">col</span> <span class="o">*</span> <span class="p">(</span><span class="nx">CELL_SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
        <span class="nx">row</span> <span class="o">*</span> <span class="p">(</span><span class="nx">CELL_SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
        <span class="nx">CELL_SIZE</span><span class="p">,</span>
        <span class="nx">CELL_SIZE</span>
      <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">ctx</span><span class="p">.</span><span class="nx">stroke</span><span class="p">();</span>
<span class="p">};</span>
</code></pre></td></tr></tbody></table></div></div>

<p>要开始渲染过程,我们将使用与上面相同的代码来开始渲染循环的第一次迭代:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3</pre></td><td class="code"><pre class="highlight"><code><span class="nx">drawGrid</span><span class="p">();</span>
<span class="nx">drawCells</span><span class="p">();</span>
<span class="nx">requestAnimationFrame</span><span class="p">(</span><span class="nx">renderLoop</span><span class="p">);</span>
</code></pre></td></tr></tbody></table></div></div>

<p>注意, 在调用 <code class="highlighter-rouge">requestAnimationFrame(renderLoop)</code> 之前调用 <code class="highlighter-rouge">drawGrid()</code> 和 <code class="highlighter-rouge">drawCells()</code>.我们这样做的原因是在我们进行修改之前绘制 universe 的初始状态.如果我们只是简单的调用 <code class="highlighter-rouge">requestAnimationFrame(renderLoop)</code> ,我们最终会得到这样一种情况,第一正被绘制实际上实在第一次调用 <code class="highlighter-rouge">universe.tick()</code> 之后,这些细胞将呈现生命周期的第二个 <code class="highlighter-rouge">tick</code>.</p>

<h2 id="它起作用了">它起作用了!</h2>

<p>在 <code class="highlighter-rouge">wasm-game-of-life</code> 目录通过 root 权限运行此命令来重建 WebAssembly 和绑定粘合剂.</p>

<pre><code class="language-hljs">wasm-pack build
</code></pre>

<p>确保您的开发服务器正在运行.如果不是请从 <code class="highlighter-rouge">wasm-game-of-life/www</code> 目录中再次启动它:</p>

<pre><code class="language-hljs">npm run start
</code></pre>

<p>如果你刷新 [http://localhost:8080/] 您应该会收到一个令人兴奋的 life 展示!</p>

<p><img src="https://rustwasm.github.io/book/images/game-of-life/initial-game-of-life.png" alt="hello wasm-pack" /></p>

<p>除此之外,还有一个非常简洁的名为 <a href="https://en.wikipedia.org/wiki/Hashlife">Hashlife</a> 的算法来实现生命游戏.它使用积极的 memoizing,并且实际上可以以指数的速度更快的计算后代!鉴于此,您可能想知道为什么我们在本教程中年没有使用 heshlife 实现.因为它超出了本文的范围,我们专注于实现 Rust 和 WebAssembly 的结合,但我们强烈推荐您自己去了解 hashlife!</p>

<h2 id="练习">练习</h2>

<ul>
  <li>用单个太空飞船初始化 universe.</li>
  <li>
    <p>不是硬编码进行初始化 universe,而是产生一个随机的,每个细胞有一半存活机会的 universe.
  <em>提示: 使用 <a href="https://crates.io/crates/js-sys">js-sys crate</a> 导入 Math.random JavaScript 函数</em></p>

    <details>

  <summary>答案</summary>

  <p>首先,将 `js-sys` 依赖添加到 `wasm-game-of-life/Cargo.toml`:</p>

  ```toml
  # ...
  [dependencies]
  js-sys = "0.3"
  # ...
  ```

  <p>然后,使用 <code>js_sys::Math::random</code> 函数进行掷硬币:</p>

  ```rust
  extern crate js_sys;

  // ...

  if js_sys::Math::random() &lt; 0.5 {
      // Alive...
  } else {
      // Dead...
  }
  ```

  &lt;/pre&gt;

  </details>
  </li>
  <li>
    <p>用字节表示每个单元格可以轻松地对单元格进行迭代,但它是以浪费内存的代价而来的.每个字节是 8 为,但我们只需要一个比特来表示每个细胞是死的还是活的.重新调整数据表示,以便每个单元仅使用一个比特的空间.</p>

    <details>

  <summary>答案</summary>

  在 Rust 中, 你可以使用 [`fuxedbutset` crate 的 `FixedBitSet` 类型](https://crates.io/crates/fixedbitset) 来表示 cells 而不是使用 `Vec<Cell>`:

  ```rust
  // Make sure you also added the dependency to Cargo.toml!
  extern crate fixedbitset;
  use fixedbitset::FixedBitSet;

  // ...

  #[wasm_bindgen]
  pub struct Universe {
      width: u32,
      height: u32,
      cells: FixedBitSet,
  }
  ```

  可以通过以下方式调整 Universe 构造函数:

  ```rust
  pub fn new() -&gt; Universe {
      let width = 64;
      let height = 64;

      let size = (width * height) as usize;
      let mut cells = FixedBitSet::with_capacity(size);

      for i in 0..size {
          cells.set(i, i % 2 == 0 || i % 7 == 0);
      }

      Universe {
          width,
          height,
          cells,
      }
  }
  ```

  要更新 Universe 的下一刻度中的 cells,我们使用 `FixedBitSet` 的 set 方法:

  ```rust
  next.set(idx, match (cell, live_neighbors) {
      (true, x) if x &lt; 2 =&gt; false,
      (true, 2) | (true, 3) =&gt; true,
      (true, x) if x &gt; 3 =&gt; false,
      (false, 3) =&gt; true,
      (otherwise, _) =&gt; otherwise
  });
  ```

  要将指向开头的执政传递给 JavaScript,可以将 `FixedBitSet` 转换为 slice,然后将 slice 转换为指针:

  ```rust
  #[wasm_bindgen]
  impl Universe {
      // ...

      pub fn cells(&amp;self) -&gt; *const u32 {
          self.cells.as_slice().as_ptr()
      }
  }
  ```

  在 JavaScript 中,从 wasm 内存构造 `Uint8Array` 与之前相同,只是数组的长度不再是 `width * height`,而是 `width * height / 8` ,因为我们每个细胞只有一比特而不是一个字节:

  ```js
  const cells = new Uint8Array(memory.buffer, cellsPtr, width * height / 8);
  ```

  给定索引和 Uint8Array`,您用以下函数确定 n <sup>th</sup> 比特是否设置:

  ```js
  const bitIsSet = (n, arr) =&gt; {
  const byte = Math.floor(n / 8);
  const mask = 1 &lt;&lt; (n % 8);
  return (arr[byte] &amp; mask) === mask;
  };
  ```

  有鉴于此,新版本的 drawCells 如下所示:

  ```js
  const drawCells = () =&gt; {
  const cellsPtr = universe.cells();

  // This is updated!
  const cells = new Uint8Array(memory.buffer, cellsPtr, width * height / 8);

  ctx.beginPath();

  for (let row = 0; row &lt; height; row++) {
      for (let col = 0; col &lt; width; col++) {
      const idx = getIndex(row, col);

      // This is updated!
      ctx.fillStyle = bitIsSet(idx, cells)
          ? ALIVE_COLOR
          : DEAD_COLOR;

      ctx.fillRect(
          col * (CELL_SIZE + 1) + 1,
          row * (CELL_SIZE + 1) + 1,
          CELL_SIZE,
          CELL_SIZE
      );
      }
  }

  ctx.stroke();
  };
  ```

</Cell></details>
  </li>
</ul>
<p>&lt;/details&gt;</p>

<ul>
  <li><a href="/rust/webassembly/2019/08/22/WebAssembly之书目录"><strong>目录</strong></a></li>
  <li>下一篇:<a href="javascript:;"><strong>测试康威生命游戏</strong></a></li>
  <li>上一篇:<a href="/rust/webassembly/2019/07/13/康威生命游戏规则/"><strong>康威生命游戏规则</strong></a></li>
</ul>

<hr />

<ul>
  <li>via: <a href="https://rustwasm.github.io/book/game-of-life/implementing.html">https://rustwasm.github.io/book/game-of-life/implementing.html</a></li>
  <li>译者: lkighy</li>
  <li>校对: -</li>
</ul>


      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            
            <a href="/tag/#/rust" rel="tag"># rust</a>
          
            
            <a href="/tag/#/WebAssembly" rel="tag"># WebAssembly</a>
          
            
            <a href="/tag/#/%E7%BF%BB%E8%AF%91" rel="tag"># 翻译</a>
          
        </div>
      

      
      
      
      
      

      
      
        <div class="post-nav" id="post-nav-id">
          <div class="post-nav-next post-nav-item">
            
              <a href="/web/webpack/2019/08/21/%E9%85%8D%E7%BD%AEwebpack/" rel="next" title="配置 webpack">
                <i class="fa fa-chevron-left"></i> 配置 webpack
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/rust/webassembly/2019/07/13/%E5%BA%B7%E5%A8%81%E7%94%9F%E5%91%BD%E6%B8%B8%E6%88%8F%E8%A7%84%E5%88%99/" rel="prev" title="康威生命游戏规则">
                康威生命游戏规则 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      
      

      
    </footer>
  </article>

  <div class="post-spread">
    
  </div>
</div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="lv-container" data-id="city" data-uid="MTAyMC80NjIxMS8yMjcyMg=="></div>
    
  </div>


        </div>
        
          

  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      
        
        
        







      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/assets/images/profile.jpg"
               alt="lkighy" />
          <p class="site-author-name" itemprop="name">lkighy</p>
           
              <p class="site-description motion-element" itemprop="description">一个以兴趣为动力的自学者.</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">10</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
        
        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            








            
              <div class="post-toc-content">
    <ol class=nav>
      <li class="nav-item nav-level-2"> <a class="nav-link" href="#设计"> <span class="nav-number">1</span> <span class="nav-text">设计</span> </a> <ol class="nav-child"> <li class="nav-item nav-level-3"> <a class="nav-link" href="#无限的-universe"> <span class="nav-number">1.1</span> <span class="nav-text">无限的 universe</span> </a> </li> <li class="nav-item nav-level-3"> <a class="nav-link" href="#连接-rust-和-javascript"> <span class="nav-number">1.2</span> <span class="nav-text">连接 Rust 和 JavaScript</span> </a> </li> <li class="nav-item nav-level-3"> <a class="nav-link" href="#在我们的生命游戏中连接-rust-和-javascript"> <span class="nav-number">1.3</span> <span class="nav-text">在我们的生命游戏中连接 Rust 和 JavaScript</span> </a> </li> </ol> </li> <li class="nav-item nav-level-2"> <a class="nav-link" href="#rust实现"> <span class="nav-number">2</span> <span class="nav-text">Rust实现</span> </a> </li> <li class="nav-item nav-level-2"> <a class="nav-link" href="#使用-javascript-渲染"> <span class="nav-number">3</span> <span class="nav-text">使用 JavaScript 渲染</span> </a> </li> <li class="nav-item nav-level-2"> <a class="nav-link" href="#直接从内存渲染到画布"> <span class="nav-number">4</span> <span class="nav-text">直接从内存渲染到画布</span> </a> </li> <li class="nav-item nav-level-2"> <a class="nav-link" href="#它起作用了"> <span class="nav-number">5</span> <span class="nav-text">它起作用了!</span> </a> </li> <li class="nav-item nav-level-2"> <a class="nav-link" href="#练习"> <span class="nav-number">6</span> <span class="nav-text">练习</span> </a> </li>
    </ol>
  </div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>

        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lkighy</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://jekyllrb.com">Jekyll</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/simpleyyt/jekyll-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>





















  
   
  
  
  
  
  
  <script type="text/javascript" src="/assets/lib/jquery/index.js?v=2.1.3"></script>

  
  
  
  
  
  <script type="text/javascript" src="/assets/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  
  
  
  
  <script type="text/javascript" src="/assets/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  
  
  
  
  <script type="text/javascript" src="/assets/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  
  
  
  
  <script type="text/javascript" src="/assets/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  
  
  
  
  <script type="text/javascript" src="/assets/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/assets/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/assets/js/src/motion.js?v=5.1.1"></script>



  
  

  <script type="text/javascript" src="/assets/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/assets/js/src/post-details.js?v=5.1.1"></script>


  


  <script type="text/javascript" src="/assets/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  











  




  

    
      <script type="text/javascript">
        (function(d, s) {
          var j, e = d.getElementsByTagName(s)[0];
          if (typeof LivereTower === 'function') { return; }
          j = d.createElement(s);
          j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
          j.async = true;
          e.parentNode.insertBefore(j, e);
        })(document, 'script');
      </script>
    

  







  






  

  

  
  


  

  

  

</body>
</html>

